let suft_form_string = '<section class="suft"><div class="suft-toggle"><button class="toggle-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 338.36 498.31"><g id="b25041ca-fcd5-4343-b40c-4838e930d3d2" data-name="color - 1"><path d="M657.09,280.65c52.3,0,94.69,34.34,94.69,76.7S709.39,434,657.09,434a112.25,112.25,0,0,1-45.18-9.27c-5.95-2.62-43.6,23.66-40.52,18.27,4.7-8.21,12.77-36.36,8.27-41.52-10.88-12.49-17.27-27.73-17.27-44.17C562.39,315,604.79,280.65,657.09,280.65ZM674.87,345c3.83-22.69-3.13-41.67-18-41.67-18,0-19.94,18.74-18,41.67,3.52,41.68,8.06,41.68,18,41.68S667.83,386.7,674.87,345ZM668,405.09a11,11,0,1,0-10.95,11A11,11,0,0,0,668,405.09Z" transform="translate(-417.42 -276.65)"/><path d="M656.87,303.35c14.87,0,21.83,19,18,41.67-7,41.68-8.06,41.68-18,41.68s-14.48,0-18-41.68C636.93,322.09,638.87,303.35,656.87,303.35Z" transform="translate(-417.42 -276.65)" style="fill:#d01700"/><path d="M657.09,394.13a11,11,0,1,1-11,11A11,11,0,0,1,657.09,394.13Z" transform="translate(-417.42 -276.65)" style="fill:#d01700"/><path d="M586.13,774.46l-168.21-1.55c0-166.69,38-194.3,84.79-194.3S586.13,604.65,586.13,774.46Z" transform="translate(-417.42 -276.65)"/><path d="M502,453.29c29,0,52.44,26.61,52.44,55.58S531,568.62,502,568.62s-52.45-30.79-52.45-59.75S473.06,453.29,502,453.29Z" transform="translate(-417.42 -276.65)"/><path d="M554.47,508.87c0,29-23.48,59.75-52.44,59.75s-52.45-30.79-52.45-59.75,23.48-55.58,52.45-55.58S554.47,479.9,554.47,508.87Z" transform="translate(-417.42 -276.65)" style="fill:none;stroke:#000;stroke-miterlimit:10"/><path d="M417.92,772.91c0-166.69,38-194.3,84.79-194.3s83.42,26,83.42,195.85" transform="translate(-417.42 -276.65)" style="fill:none;stroke:#000;stroke-miterlimit:10"/><line x1="168.71" y1="497.81" x2="0.5" y2="496.26" style="fill:none;stroke:#000;stroke-miterlimit:10"/><path d="M751.78,357.35c0,42.36-42.39,76.69-94.69,76.69a112.25,112.25,0,0,1-45.18-9.27c-5.95-2.62-43.6,23.66-40.52,18.27,4.7-8.21,12.77-36.36,8.27-41.52-10.88-12.49-17.27-27.73-17.27-44.17,0-42.36,42.4-76.7,94.7-76.7S751.78,315,751.78,357.35Z" transform="translate(-417.42 -276.65)" style="fill:none;stroke:#000;stroke-miterlimit:10"/><path d="M668,405.09a11,11,0,1,1-10.95-11A10.95,10.95,0,0,1,668,405.09Z" transform="translate(-417.42 -276.65)" style="fill:none;stroke:#000;stroke-miterlimit:10"/><path d="M674.87,345c-7,41.68-8.06,41.68-18,41.68s-14.48,0-18-41.68c-1.94-22.93,0-41.67,18-41.67C671.74,303.35,678.7,322.33,674.87,345Z" transform="translate(-417.42 -276.65)" style="fill:none;stroke:#000;stroke-miterlimit:10"/></g><g id="a6970e8f-5a33-41a7-b38d-51c01208f054" data-name="color - 2"><path d="M657.09,280.65c52.3,0,94.69,34.34,94.69,76.7S709.39,434,657.09,434a112.25,112.25,0,0,1-45.18-9.27c-5.95-2.62-43.6,23.66-40.52,18.27,4.7-8.21,12.77-36.36,8.27-41.52-10.88-12.49-17.27-27.73-17.27-44.17C562.39,315,604.79,280.65,657.09,280.65ZM674.87,340c3.83-20-3.13-36.69-18-36.69-18,0-19.94,16.5-18,36.69,3.52,36.7,8.06,36.7,18,36.7S667.83,376.74,674.87,340Zm-6.83,65a11,11,0,1,0-10.95,11A11,11,0,0,0,668,405.09Z" transform="translate(-417.42 -276.65)" style="fill:#e8e8e8"/><path d="M656.87,303.35c14.87,0,21.83,16.71,18,36.69-7,36.7-8.06,36.7-18,36.7s-14.48,0-18-36.7C636.93,319.85,638.87,303.35,656.87,303.35Z" transform="translate(-417.42 -276.65)" style="fill:#2400b9"/><path d="M657.09,394.13a11,11,0,1,1-11,11A11,11,0,0,1,657.09,394.13Z" transform="translate(-417.42 -276.65)" style="fill:#2400b9"/><path d="M586.13,774.46l-168.21-1.55c0-166.69,38-194.3,84.79-194.3S586.13,604.65,586.13,774.46Z" transform="translate(-417.42 -276.65)"/><path d="M502,453.29c29,0,52.44,26.61,52.44,55.58S531,568.62,502,568.62s-52.45-30.79-52.45-59.75S473.06,453.29,502,453.29Z" transform="translate(-417.42 -276.65)"/><path d="M554.47,508.87c0,29-23.48,59.75-52.44,59.75s-52.45-30.79-52.45-59.75,23.48-55.58,52.45-55.58S554.47,479.9,554.47,508.87Z" transform="translate(-417.42 -276.65)" style="fill:none;stroke:#000;stroke-miterlimit:10"/><path d="M417.92,772.91c0-166.69,38-194.3,84.79-194.3s83.42,26,83.42,195.85" transform="translate(-417.42 -276.65)" style="fill:none;stroke:#000;stroke-miterlimit:10"/><line x1="168.71" y1="497.81" x2="0.5" y2="496.26" style="fill:none;stroke:#000;stroke-miterlimit:10"/><path d="M751.78,357.35c0,42.36-42.39,76.69-94.69,76.69a112.25,112.25,0,0,1-45.18-9.27c-5.95-2.62-43.6,23.66-40.52,18.27,4.7-8.21,12.77-36.36,8.27-41.52-10.88-12.49-17.27-27.73-17.27-44.17,0-42.36,42.4-76.7,94.7-76.7S751.78,315,751.78,357.35Z" transform="translate(-417.42 -276.65)" style="fill:none;stroke:#000;stroke-miterlimit:10;stroke-width:8px"/><path d="M668,405.09a11,11,0,1,1-10.95-11A10.95,10.95,0,0,1,668,405.09Z" transform="translate(-417.42 -276.65)" style="fill:none;stroke:#000;stroke-miterlimit:10"/><path d="M674.87,340c-7,36.7-8.06,36.7-18,36.7s-14.48,0-18-36.7c-1.94-20.19,0-36.69,18-36.69C671.74,303.35,678.7,320.06,674.87,340Z" transform="translate(-417.42 -276.65)" style="fill:none;stroke:#000;stroke-miterlimit:10"/></g></svg></button></div><div class="suft-content"><div class="content-close"><button class="close-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="suft-target-type"><div class="suft-target-type-options"><input type="radio" name="suft-info-target-type" id="suft-info-target-type-element" class="type-option" value="element"><label for="suft-info-target-type-element" class="type-option-display"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-square"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></label><input type="radio" name="suft-info-target-type" id="suft-info-target-type-draw" class="type-option" value="draw"><label for="suft-info-target-type-draw" class="type-option-display"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-maximize"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg></label><input type="radio" name="suft-info-target-type" id="suft-info-target-type-describe" class="type-option" value="describe"><label for="suft-info-target-type-describe" class="type-option-display"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-3"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg></label></div></div><div class="suft-comment"><label for="suft-info-comment">Comment</label><textarea name="suft-info-comment" id="suft-info-comment" cols="10" rows="6"></textarea></div><div class="suft-priority"><label for="suft-info-priority">Priority</label><select name="suft-info-priority" id="suft-info-priority"><option value="low" selected>Low</option><option value="medium">Medium</option><option value="high">High</option></select></div><div class="suft-save"><button type="button" class="save-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button></div></div></section>';
let suft_selected_string = '<section class="suft-selected" style="top: 0px; left: 0px; height: 0px; width: 0px;"><div class="suft-selected-top"></div><div class="suft-selected-right"></div><div class="suft-selected-bottom"></div><div class="suft-selected-left"></div></section>';

let suft_user_details = {};
let suft_status = {
    'active': false,
    'target_type': '',
    'target_element': '',
    'target_draw_start_x': '',
    'target_draw_start_y': '',
    'target_draw_end_x': '',
    'target_draw_end_y': '',
    'comment': '',
    'priority': 'low'
};

let suft = null;
let suft_open = null;
let suft_close = null;
let suft_selected = null;

// OnLoad Run
window.addEventListener('load', function() {
    const parser = new DOMParser();
    const suft_form_html = parser.parseFromString(suft_form_string, "text/html");
    const suft_selected_html = parser.parseFromString(suft_selected_string, "text/html");

    document.body.appendChild(suft_form_html.documentElement);
    document.body.appendChild(suft_selected_html.documentElement);

    suft = document.querySelector('.suft');
    suft_open = document.querySelector('.suft-toggle .toggle-button');
    suft_close = document.querySelector('.content-close .close-button');
    suft_selected = document.querySelector('.suft-selected');
    suft_save = document.querySelector('.suft-save .save-button');
    suft_info_comment = document.querySelector('#suft-info-comment');
    suft_info_priority = document.querySelector('#suft-info-priority');

    suft_open.addEventListener('click', function() {
        SuftOpen();
    });

    suft_close.addEventListener('click', function() {
        SuftClose();
    });

    suft_save.addEventListener('click', function() {
        console.log(suft_user_details, suft_status);
    });

    window.addEventListener('scroll', function(event) {
        suft.style.top = 'calc(40% + ' + window.scrollY + 'px)';
    });

    document.addEventListener('mousemove', function(event) {
        if (suft_status.target_type === 'draw') {
            if (suft_status.target_draw_start_x !== '' && suft_status.target_draw_end_x === '') {
                SuftDrawSelected(suft_status.target_draw_start_y, suft_status.target_draw_start_x, event.pageY - suft_status.target_draw_start_y , event.pageX - suft_status.target_draw_start_x);
            }
        }
    });

    document.addEventListener('mousedown', function(event) {
        if (suft_status.target_type === 'element') {
            if (!IsElementInsideSuft(event.target)) {
                suft_status.target_element = SuftBuildTargetElementPath(event.composedPath());
                SuftDrawSelected(event.target.offsetTop, event.target.offsetLeft, event.target.scrollHeight, event.target.scrollWidth);
            }
        }
        if (suft_status.target_type === 'draw') {
            if (event.button === 0) {
                if (!IsElementInsideSuft(event.target)) {
                    SuftResetDraw();
                    suft_status.target_draw_end_x = '';
                    suft_status.target_draw_end_y = '';

                    suft_status.target_draw_start_x = event.pageX;
                    suft_status.target_draw_start_y = event.pageY;
                }
            }
        }
    });

    document.addEventListener('mouseup', function(event) {
        if (suft_status.target_type === 'draw') {
            if (event.button === 0) {
                suft_status.target_draw_end_x = event.pageX;
                suft_status.target_draw_end_y = event.pageY;
            }
        }
    });

    Array.from(document.querySelectorAll('[name="suft-info-target-type"]')).forEach(function(radio) {
        radio.addEventListener('change', function() {
            suft_status.target_type = radio.value;
            SuftResetDrawData();
            SuftResetDraw();
        });
    });

    suft_info_comment.addEventListener('change', function(event) {
        suft_status.comment = event.target.value;
    });

    suft_info_priority.addEventListener('change', function(event) {
        suft_status.priority = event.target.value;
    });
});

function GiveAllElementsSuftId() {
    var id_inter = 0;

    Array.from(document.querySelectorAll('*')).forEach(function(element) {
        element.setAttribute('data-suft-target-id', id_inter);
        id_inter = id_inter + 1;
    });
}

function SuftOpen() {
    SuftResetForm();
    suft.classList.add('suft-active');
    SuftCaptureBrowserDetails();
    GiveAllElementsSuftId();
    suft_status.active = true;
}

function SuftClose() {
    suft.classList.remove('suft-active');
    SuftResetForm();
    suft_status.active = false;
}

function SuftCaptureBrowserDetails() {
    if (navigator.userAgent.includes('Firefox/')) {
        suft_user_details.browser_name = 'firefox';
        suft_user_details.browser_version = navigator.userAgent.split('Firefox/')[1];
    }
    else if (navigator.userAgent.includes('Edg/')) {
        suft_user_details.browser_name = 'edge';
        suft_user_details.browser_version = navigator.userAgent.split('Edg/')[1];
    }
    else if (navigator.userAgent.includes('Chrome/')) {
        suft_user_details.browser_name = 'chrome';
        suft_user_details.browser_version = navigator.userAgent.split('Chrome/')[1].split(' ')[0];
    }
    else if (navigator.userAgent.includes('Safari/')) {
        suft_user_details.browser_name = 'safari';
        suft_user_details.browser_version = navigator.userAgent.split('Safari/')[1];
    }

    suft_user_details.device_platform = navigator.userAgentData.platform;

    suft_user_details.viewport_width = document.documentElement.clientWidth;
    suft_user_details.viewport_height = document.documentElement.clientHeight;
}

function IsElementInsideSuft(element) {
    suft_contains_element = false;

    while (element !== null) {
        if (element === suft) {
            suft_contains_element = true;
        }
        element = element.parentElement;
    }

    return suft_contains_element;
}

function SuftBuildTargetElementPath(path) {
    var path_depth = 0;
    var path_as_string = '';

    path.forEach(function(node) {
        if (node.outerHTML) {
            if (path_depth === 0) {
                path_as_string = node.outerHTML;
            }
            else {
                path_as_string = node.outerHTML.split('>')[0] + '>\n' + path_as_string;
            }

            path_depth = path_depth + 1;
        }
    });

    return path_as_string;
}

function SuftResetForm() {
    var target_type_checked = document.querySelector('[name="suft-info-target-type"]:checked');
    if (target_type_checked) {
        target_type_checked.checked = false;
    }

    suft_info_comment.value = '';
    suft_info_priority.value = 'low';

    suft_status.target_type = '';
    suft_status.comment = '';
    suft_status.priority = 'low';

    SuftResetDrawData();
    SuftResetDraw();
}

function SuftResetDrawData() {
    suft_status.target_element = '';
    suft_status.target_draw_start_x = '';
    suft_status.target_draw_start_y = '';
    suft_status.target_draw_end_x = '';
    suft_status.target_draw_end_y = '';
}

function SuftResetDraw() {
    suft_selected.classList.remove('suft-selected-active');
    suft_selected.style.top = '0px';
    suft_selected.style.left = '0px';
    suft_selected.style.height = '0px';
    suft_selected.style.width = '0px';
}

function SuftDrawSelected(top, left, height, wieght) {
    suft_selected.classList.add('suft-selected-active');
    suft_selected.style.top = (top - 3) + 'px';
    suft_selected.style.left = (left - 3) + 'px';
    suft_selected.style.height = height + 'px';
    suft_selected.style.width = (wieght + 3) + 'px';
}